<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>BandApp Pro - Live Sync</title>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <style>
    :root{
      --bg:#000;
      --text:#eee;
      --accent:#ff9800;
      --edit:#2196F3;
      --pu-bg: rgba(168, 85, 247, 0.16);
--pu-border: rgba(168, 85, 247, 0.55);
--pu-text: var(--text);

      /* th√®mes */
      --nav-bg:#1a1a1a;
      --nav-text:#eee;
      --panel-bg:#111;
      --panel-border:#333;

      --chorus-bg:#111827;
      --chorus-border:#60a5fa;
      --chorus-text: var(--text);

      --comment-bg:#ffd54f;
      --comment-text:#000;
    }

      /* ===== Bloc perso utilisateur {pu:Nom} ===== */

      .pu-block{
  margin:14px 0;
  border-left:4px solid var(--pu-border);
  padding:10px 12px;
  border-radius:12px;
  background: var(--pu-bg);
  color: var(--pu-text);
}

.pu-label{
  font-family:sans-serif;
  font-weight:900;
  font-size:12px;
  opacity:.65;
  margin-bottom:8px;
}

.pu-pre{
  margin:0;
  white-space:pre;
  overflow-x:auto;

  /* IMPORTANT : hauteur stable */
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
  font-size:14px;      /* FIXE */
  line-height:1.25;    /* FIXE */
}

    body{
      font-family:sans-serif;
      background:var(--bg);
      color:var(--text);
      margin:0;
      overflow:hidden;
      overscroll-behavior-x:none;
    }

    /* --- Bouton r√©glages FIXE (visible partout) --- */
    #settingsFixedWrap{
      position:fixed;
      top:10px;
      right:10px;
      z-index:6000;
      display:flex;
      align-items:center;
      gap:8px;
    }

    #settingsBtnFixed{
      border:2px solid var(--accent);
      border-radius:10px;
      background:rgba(0,0,0,0.25);
      color:var(--accent);
      font-weight:900;
      padding:10px 12px;
      cursor:pointer;
      backdrop-filter: blur(6px);
    }

    #settingsUserLabel{
      font-weight:900;
      font-size:12px;
      color:var(--text);
      background:rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.15);
      padding:8px 10px;
      border-radius:10px;
      max-width:38vw;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* Toast */
    #toast{
      position:fixed;
      left:50%;
      top:18px;
      transform:translateX(-50%);
      z-index:7000;
      background:rgba(0,0,0,0.85);
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.15);
      display:none;
      font-size:14px;
      font-weight:700;
      max-width:min(92vw, 520px);
      text-align:center;
    }

    /* ==== USER PICKER ==== */
    #userOverlay{
      position:fixed;
      inset:0;
      z-index:5000;
      display:none;
      background:rgba(0,0,0,0.92);
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    #userModal{
      width:min(560px,100%);
      background:#111;
      border:1px solid #2a2a2a;
      border-radius:14px;
      overflow:hidden;
    }
    #userModal header{
      padding:14px 16px;
      border-bottom:1px solid #2a2a2a;
      background:#161616;
    }
    #userModal header h3{
      margin:0;
      font-size:14px;
      color:#fff;
    }
    #userModal .content{ padding:14px 16px; }
    #userModal .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .user-choice{
      border:1px solid #333;
      background:#0b0b0b;
      border-radius:12px;
      padding:12px;
      cursor:pointer;
      text-align:center;
      font-weight:bold;
      color:#fff;
      user-select:none;
    }
    .user-choice:hover{ background:#101010; }
    #userModal .actions{
      padding:14px 16px;
      border-top:1px solid #2a2a2a;
      display:flex;
      justify-content:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Biblioth√®que */
    #library{
      height:100vh;
      overflow-y:auto;
      display:block;
      -webkit-overflow-scrolling:touch;
    }
    .lib-header{
      padding:20px;
      background:var(--nav-bg);
      border-bottom:2px solid var(--accent);
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:sticky;
      top:0;
      z-index:5;
      color:var(--nav-text);
    }
    .song-item{
      padding:20px;
      border-bottom:1px solid #222;
      display:flex;
      justify-content:space-between;
      font-size:1.1em;
      cursor:pointer;
    }

    /* Lecteur */
    #viewer-container{
      display:none;
      position:fixed;
      top:0;
      left:0;
      width:100vw;
      height:100vh;
      background:var(--bg);
      z-index:10;
    }
    nav{
      display:flex;
      background:var(--nav-bg);
      color:var(--nav-text);
      min-height:60px;
      align-items:center;
      padding:0 10px;
      gap:8px;
      border-bottom:1px solid var(--panel-border);
      flex-wrap:wrap;
    }
    .controls-group{
      display:flex;
      align-items:center;
      gap:5px;
      background:rgba(255,255,255,0.06);
      padding:5px;
      border-radius:8px;
    }

    .version-badge{
      font-weight:900;
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(255,255,255,0.08);
      color:var(--text);
      white-space:nowrap;
    }
    .version-badge.perso{
      border-color: rgba(59,130,246,0.55);
      background: rgba(59,130,246,0.18);
    }
    .version-badge.off{
      border-color: rgba(255,152,0,0.55);
      background: rgba(255,152,0,0.18);
    }

    /* Bandeau update */
    #updateBanner{
      position:sticky;
      top:0;
      z-index:999;
      display:none;
      background:rgba(255,255,255,0.06);
      border-bottom:1px solid var(--panel-border);
      padding:10px 12px;
      font-size:14px;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color:var(--text);
    }
    #updateBanner .msg{ color:var(--text); }
    #updateBanner .btn-small{
      padding:8px 10px;
      border-radius:6px;
      font-size:12px;
    }

    /* Panneau notes */
    #notesPanel{
      display:none;
      background:var(--panel-bg);
      border-bottom:1px solid var(--panel-border);
      padding:12px;
    }
    #notesTextarea{
      width:100%;
      min-height:120px;
      background:#000;
      color:#0f0;
      border:1px solid #333;
      padding:10px;
      font-family:monospace;
      resize:vertical;
      box-sizing:border-box;
    }

    #viewer{
      height:calc(100vh - 65px);
      overflow-y:scroll;
      padding:25px;
      font-family:'Courier New', Courier, monospace;
      -webkit-overflow-scrolling:touch;
      scroll-behavior:auto !important;
      touch-action:pan-y;
    }

    /* Rendu ChordPro */
    .block{ margin-bottom:26px; }
    .chordline,.lyricline{
      white-space:pre-wrap;
      word-break:break-word;
      overflow-wrap:anywhere;
      line-height:1.6;
      margin:0;
    }
    .chordline{ color:var(--accent); font-weight:bold; }

    /* Commentaires {c:...} : surlignage sur le texte uniquement + police plus grande */
    .commentwrap{ margin:12px 0; }
    .commentline{
      display:inline-block;
      background:var(--comment-bg);
      color:var(--comment-text);
      padding:6px 10px;
      border-radius:8px;
      font-family:sans-serif;
      font-weight:900;
      font-size:18px;
      line-height:1.2;
    }

    /* Chorus bloc */
    .chorus-block{
      background:var(--chorus-bg);
      border-left:4px solid var(--chorus-border);
      padding:12px 12px;
      border-radius:12px;
      margin:14px 0;
      color:var(--chorus-text);
    }

    /* √âditeur */
    #editor-container{
      display:none;
      position:fixed;
      top:60px;
      left:0;
      width:100vw;
      height:calc(100vh - 60px);
      background:#111;
      z-index:20;
    }
    #editor-textarea{
      width:100%;
      height:80%;
      background:#000;
      color:#2196F3;
      border:none;
      font-family:monospace;
      font-size:16px;
      padding:20px;
      box-sizing:border-box;
    }
    .editor-footer{
      height:20%;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:20px;
      background:var(--nav-bg);
    }

    .btn{
      cursor:pointer;
      padding:10px 14px;
      border:2px solid var(--accent);
      border-radius:6px;
      color:var(--accent);
      background:none;
      font-size:13px;
      font-weight:bold;
    }
    .btn-blue{ border-color:var(--edit); color:var(--edit); }
    .active-btn{ background:#444; color:#fff; }

    /* Modal choix √©dition */
    #editChoiceBackdrop{
      position:fixed;
      inset:0;
      display:none;
      z-index:2000;
      background:rgba(0,0,0,0.75);
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    #editChoiceModal{
      width:min(560px,100%);
      background:#121212;
      border:1px solid #2a2a2a;
      border-radius:14px;
      overflow:hidden;
    }
    #editChoiceModal header{ padding:14px 16px; border-bottom:1px solid #2a2a2a; background:#161616; }
    #editChoiceModal header h3{ margin:0; font-size:14px; color:#fff; }
    #editChoiceModal .content{ padding:14px 16px; }
    #editChoiceModal .actions{ padding:14px 16px; border-top:1px solid #2a2a2a; display:flex; justify-content:flex-end; }
    .choice{
      border:1px solid #333;
      background:#0b0b0b;
      border-radius:12px;
      padding:12px;
      cursor:pointer;
    }
    .choice:hover{ background:#101010; }
    .choice b{ color:#fff; display:block; margin-bottom:6px; }
    .choice .small{ color:#aaa; font-size:12px; display:block; }

    /* === OVERLAYS (grilles perso sous une ligne, sans impacter la mise en page) === */
    #songContent { position: relative; } /* important pour les positions absolues */

    #overlayLayer{
      position:absolute;
      inset:0;
      pointer-events:none; /* overlay ne bloque pas le scroll */
      z-index:3;
    }

    /* bloc grille */
    .gridOverlay{
      position:absolute;
      left:0;
      right:0;
      padding:0 6px;
      pointer-events:auto;
    }

    .gridOverlay .box{
      display:inline-block;          /* largeur = contenu */
      max-width:100%;
      background: rgba(34, 197, 94, 0.18);
      border: 1px solid rgba(34, 197, 94, 0.45);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-weight: 800;
      font-size: 14px;
      line-height: 1.25;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
    }
  </style>
</head>

<body>
  <div id="settingsFixedWrap">
    <span id="topVersionBadge" class="version-badge">‚Äî</span>
    <button id="settingsBtnFixed" onclick="openSettings()">‚öôÔ∏è</button>
    <span id="settingsUserLabel"></span>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <!-- Overlay choix utilisateur -->
  <div id="userOverlay">
    <div id="userModal">
      <header><h3>Choisir l‚Äôutilisateur</h3></header>
      <div class="content">
        <div class="grid" id="userGrid"></div>
      </div>
      <div class="actions">
        <button class="btn" style="border-color:#777;color:#777;" onclick="addUser()">+ Ajouter</button>
      </div>
    </div>
  </div>

  <!-- Modal choix √©dition -->
  <div id="editChoiceBackdrop">
    <div id="editChoiceModal">
      <header><h3>Type de modification</h3></header>
      <div class="content">
        <div class="choice" onclick="chooseEditMode('personal')">
          <b>Modification personnelle</b>
          <span class="small">Sauvegard√©e pour <b>cet utilisateur</b> uniquement (ne modifie pas le fichier partag√©).</span>
        </div>
        <div style="height:10px"></div>
        <div class="choice" onclick="chooseEditMode('global')">
          <b>Modification pour tout le monde</b>
          <span class="small">Modifie le fichier partag√© (PIN demand√© imm√©diatement).</span>
        </div>
      </div>
      <div class="actions">
        <button class="btn" onclick="closeEditChoice()" style="border-color:#777;color:#777;">ANNULER</button>
      </div>
    </div>
  </div>

  <div id="library">
    <div class="lib-header">
      <h2 style="margin:0;">R√©pertoire</h2>
      <span style="opacity:.8; font-size:12px;"></span>
    </div>
    <div id="songList"></div>
  </div>

  <div id="viewer-container">
    <nav>
      <button class="btn" onclick="closeViewer()">‚¨Ö</button>

      <div class="controls-group">
        <button class="btn" id="playBtn" onclick="toggleAutoScroll(true)">‚ñ∂</button>
        <input type="range" id="scrollSpeed" min="1" max="95" value="50">
      </div>

      <div class="controls-group">
        <button class="btn" onclick="updateFontSize(-2)">A-</button>
        <button class="btn" onclick="updateFontSize(2)">A+</button>
      </div>

      <div class="controls-group">
        <button class="btn" onclick="updateTranspose(-1)">-</button>
        <span id="transposeVal" style="min-width:20px; text-align:center">0</span>
        <button class="btn" onclick="updateTranspose(1)">+</button>
      </div>

      <button class="btn" onclick="toggleNotes()">NOTES</button>
      <button class="btn" onclick="addGridUnderCurrentLine()">‚ûï GRILLE</button>
      <button class="btn btn-blue" onclick="openEditor()">√âDITER</button>
    </nav>

    <div id="updateBanner">
      <div class="msg">Une mise √† jour de cette chanson est disponible.</div>
      <div style="display:flex; gap:8px;">
        <button class="btn btn-small" onclick="dismissUpdate()">PLUS TARD</button>
        <button class="btn btn-blue btn-small" onclick="reloadCurrentSong()">RECHARGER</button>
      </div>
    </div>

    <div id="notesPanel">
      <textarea id="notesTextarea" placeholder="Tes annotations personnelles..."></textarea>
    </div>

    <div id="viewer">
      <div id="songContent"></div>
      <div style="height: 85vh;"></div>
    </div>
  </div>

  <div id="editor-container">

    <!-- ICI on colle -->
    <div id="editor-toolbar" style="
      padding:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      border-bottom:1px solid #2a2a2a;
      background:rgba(255,255,255,0.03);
    ">
      <button class="btn" onclick="insertTemplatePU()">+ {pu}</button>
      <button class="btn" onclick="insertAtCursor('{soc}\n')">+ {soc}</button>
      <button class="btn" onclick="insertAtCursor('\n{eoc}\n')">+ {eoc}</button>
      <button class="btn" onclick="insertTemplateComment()">+ {c:}</button>
      <button class="btn" onclick="insertAtCursor('[Accord]')">+ [ ]</button>
  
      <div style="flex:1"></div>
  
      <div id="chordBank" style="
        display:flex;
        flex-wrap:wrap;
        gap:6px;
        align-items:center;
      "></div>
    </div>
  
    <!-- textarea d√©j√† existant -->
    <textarea id="editor-textarea" spellcheck="false"></textarea>
    <div class="editor-footer">
      <button class="btn" onclick="closeEditor()" style="border-color: #ff5252; color: #ff5252;">ANNULER</button>
      <button class="btn btn-blue" onclick="saveEditor()">ENREGISTRER</button>
    </div>
  </div>

  <!-- Modal R√©glages -->
  <div id="settingsBackdrop" style="
    position:fixed; inset:0; display:none; z-index:6500;
    background:rgba(0,0,0,0.75); align-items:center; justify-content:center; padding:18px;">
    <div id="settingsModal" style="width:min(560px,100%); background:#121212; border:1px solid #2a2a2a; border-radius:14px; overflow:hidden;">
      <header style="padding:14px 16px; border-bottom:1px solid #2a2a2a; background:#161616;">
        <h3 style="margin:0; font-size:14px; color:#fff;">R√©glages</h3>
      </header>

      <div style="padding:14px 16px; display:grid; gap:10px;">
        <button class="btn" onclick="openUserFromSettings()">üë§ Utilisateur</button>
        <button class="btn" id="settingsLeaderBtn" onclick="toggleLeader()">Mode Solo</button>
        <button class="btn" id="settingsChordBtn" onclick="toggleChordStyle()">Accords: Do</button>
        <button class="btn" id="settingsThemeBtn" onclick="toggleTheme()">Th√®me: Sombre</button>
        <button class="btn" onclick="exportBackup()">‚¨áÔ∏è Exporter sauvegarde</button>
        <button class="btn" onclick="triggerImport()">‚¨ÜÔ∏è Importer sauvegarde</button>
        <button class="btn" onclick="revertToOfficial()">‚Ü©Ô∏é Revenir √† la version officielle</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" onchange="handleImportFile(event)">
      </div>

      <div style="padding:14px 16px; border-top:1px solid #2a2a2a; display:flex; justify-content:flex-end;">
        <button class="btn btn-blue" onclick="closeSettings()">OK</button>
      </div>
    </div>
  </div>

  <script>
    const socket = io();

    let isLeader = false, allSongs = [], currentIndex = -1;
    let currentRaw = "", currentFileName = "", fontSize = 26, transposeValue = 0;

    let isRemoteScrolling = false;

    // Auto-scroll
    let isScrolling = false;
    let rafId = null;
    let lastRafTime = 0;
    let scrollCarry = 0;

    const viewerElement = document.getElementById('viewer');
    const songContentEl = document.getElementById('songContent');
    const speedInput = document.getElementById('scrollSpeed');
    const updateBanner = document.getElementById('updateBanner');

    const notesPanel = document.getElementById('notesPanel');
    const notesTextarea = document.getElementById('notesTextarea');

    // --- SWIPE ---
    let touchStartX = 0, touchStartY = 0;
    const SWIPE_MIN_X = 110;
    const SWIPE_RATIO = 1.4;

    // --- EDIT MODE + PIN CACHE ---
    let editMode = null;
    let globalPinCache = "";

    // --- USERS ---
    const DEFAULT_USERS = ["Nemo","Estelle","Gillou","Bubu","Christian","Christophe"];
    let currentUser = "";
    let users = [];

    const userOverlay = document.getElementById('userOverlay');
    const userGrid = document.getElementById('userGrid');

    // --- SETTINGS ---
    const settingsBackdrop = document.getElementById('settingsBackdrop');
    const settingsBtnFixed = document.getElementById('settingsBtnFixed');

    // --- TOAST ---
    const toastEl = document.getElementById('toast');
    let toastTimer = null;
    function showToast(msg) {
      if (toastTimer) clearTimeout(toastTimer);
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      toastTimer = setTimeout(() => { toastEl.style.display = 'none'; }, 1700);
    }

    // --- CHORD STYLE ---
    let chordStyle = localStorage.getItem('bandapp_chordStyle') || 'latin'; // latin|american

    // --- THEME ---
    let themeMode = localStorage.getItem('bandapp_theme') || 'dark'; // dark|light

    function applyTheme() {
      const root = document.documentElement;

      if (themeMode === 'light') {
        root.style.setProperty('--bg', '#f7f7f7');
        root.style.setProperty('--text', '#111');

        root.style.setProperty('--nav-bg', '#ffffff');
        root.style.setProperty('--nav-text', '#111');
        root.style.setProperty('--panel-bg', '#ffffff');
        root.style.setProperty('--panel-border', '#d6d6d6');

        root.style.setProperty('--chorus-bg', '#eaf2ff');
        root.style.setProperty('--chorus-border', '#3b82f6');
        root.style.setProperty('--chorus-text', '#111');

        root.style.setProperty('--comment-bg', '#ffe08a');
        root.style.setProperty('--comment-text', '#111');

        settingsBtnFixed.style.background = 'rgba(255,255,255,0.7)';
      } else {
        root.style.setProperty('--bg', '#000');
        root.style.setProperty('--text', '#eee');

        root.style.setProperty('--nav-bg', '#1a1a1a');
        root.style.setProperty('--nav-text', '#eee');
        root.style.setProperty('--panel-bg', '#111');
        root.style.setProperty('--panel-border', '#333');

        root.style.setProperty('--chorus-bg', '#111827');
        root.style.setProperty('--chorus-border', '#60a5fa');
        root.style.setProperty('--chorus-text', '#eee');

        root.style.setProperty('--comment-bg', '#ffd54f');
        root.style.setProperty('--comment-text', '#000');

        settingsBtnFixed.style.background = 'rgba(0,0,0,0.25)';
      }
    }

    function updateVersionIndicator() {
      const badge = document.getElementById('topVersionBadge');
      if (!badge) return;

      const hasSong = !!currentFileName;
      const hasPersonal = hasSong && !!getPersonalSong(currentFileName);

      if (!hasSong) {
        badge.textContent = "‚Äî";
        badge.classList.remove('perso','off');
      } else if (hasPersonal) {
        badge.textContent = "PERSO";
        badge.classList.add('perso');
        badge.classList.remove('off');
      } else {
        badge.textContent = "OFFICIELLE";
        badge.classList.add('off');
        badge.classList.remove('perso');
      }
    }

    function revertToOfficial() {
      if (!currentFileName) {
        showToast("Aucune chanson ouverte");
        return;
      }

      const ok = confirm(
        "Revenir √† la version officielle ?\n\n" +
        "Cela supprimera ta version personnelle pour ce morceau (uniquement pour toi)."
      );
      if (!ok) return;

      localStorage.removeItem(personalSongKey(currentFileName));

      stopAutoScroll();
      loadSong(currentFileName);
      updateVersionIndicator();

      showToast("Version officielle restaur√©e ‚úÖ");
    }

    function toggleTheme() {
      themeMode = (themeMode === 'dark') ? 'light' : 'dark';
      localStorage.setItem('bandapp_theme', themeMode);
      applyTheme();
      syncSettingsUI();
    }

    function openSettings() {
      syncSettingsUI();
      settingsBackdrop.style.display = 'flex';
    }

    function openUserFromSettings() {
      closeSettings();
      setTimeout(() => openUserPicker(true), 50);
    }

    function closeSettings() {
      settingsBackdrop.style.display = 'none';
    }

    function syncSettingsUI() {
      const lb = document.getElementById('settingsLeaderBtn');
      if (lb) lb.innerText = isLeader ? "Mode Leader" : "Mode Solo";

      const cb = document.getElementById('settingsChordBtn');
      if (cb) cb.innerText = (chordStyle === 'latin') ? "Accords: Do" : "Accords: C";

      const tb = document.getElementById('settingsThemeBtn');
      if (tb) tb.innerText = (themeMode === 'dark') ? "Th√®me: Sombre" : "Th√®me: Clair";
    }

    function loadUsersList() {
      const savedList = localStorage.getItem('bandapp_users');
      if (savedList) {
        try {
          const parsed = JSON.parse(savedList);
          if (Array.isArray(parsed) && parsed.length) return parsed;
        } catch {}
      }
      return [...DEFAULT_USERS];
    }

    function saveUsersList() {
      localStorage.setItem('bandapp_users', JSON.stringify(users));
    }

    function renderUserGrid() {
      userGrid.innerHTML = "";
      users.forEach(name => {
        const div = document.createElement('div');
        div.className = 'user-choice';
        div.textContent = name;
        div.onclick = () => setCurrentUser(name, true);
        userGrid.appendChild(div);
      });
    }

    function setCurrentUser(name, fromPicker) {
      currentUser = String(name || "").trim();
      if (!currentUser) return;
      localStorage.setItem('bandapp_currentUser', currentUser);
      const lab = document.getElementById('settingsUserLabel');
      if (lab) lab.textContent = currentUser;

      if (currentFileName) {
        stopAutoScroll();
        loadSong(currentFileName);
        loadNotes();
        renderGrids();
      }

      if (fromPicker) {
        userOverlay.style.display = 'none';
        showToast(`Bienvenue ${currentUser}`);
      }
    }

    function openUserPicker(force) {
      const saved = localStorage.getItem('bandapp_currentUser') || "";
      if (!force && saved) return;
      userOverlay.style.display = 'flex';
      renderUserGrid();
    }

    function addUser() {
      const name = prompt("Nom du nouvel utilisateur ?") || "";
      const clean = String(name).trim();
      if (!clean) return;
      if (users.some(u => u.toLowerCase() === clean.toLowerCase())) return;

      users.push(clean);
      users.sort((a,b)=>a.localeCompare(b, 'fr', { sensitivity:'base' }));
      saveUsersList();
      renderUserGrid();
    }

    function initUsers() {
      users = loadUsersList();
      saveUsersList();

      const saved = localStorage.getItem('bandapp_currentUser') || "";
      if (saved) {
        setCurrentUser(saved, false);
      } else {
        openUserPicker(true);
      }
    }

    // Connexion t√©moin (bordure du bouton fixe)
    socket.on('connect', () => { settingsBtnFixed.style.borderColor = "#4CAF50"; });
    socket.on('disconnect', () => { settingsBtnFixed.style.borderColor = "#f44336"; });

    async function fetchSongs() {
      const res = await fetch('/list-songs');
      allSongs = (await res.json()).sort();
      document.getElementById('songList').innerHTML = allSongs.map((s, idx) => `
        <div class="song-item" onclick="openSong(${idx})">
          <b>${s.replace('.pro','').replace('.cho','')}</b><span>‚ùØ</span>
        </div>`).join('');
    }

    function toggleLeader() {
      isLeader = !isLeader;
      if (!isLeader) stopAutoScroll();
      syncSettingsUI();
    }

    function openSong(idx) {
      if (idx < 0 || idx >= allSongs.length) return;
      currentIndex = idx;
      currentFileName = allSongs[idx];

      updateBanner.style.display = 'none';
      notesPanel.style.display = 'none';

      document.getElementById('library').style.display = 'none';
      document.getElementById('viewer-container').style.display = 'block';

      if (isLeader) socket.emit('change-song', currentFileName);

      loadSong(currentFileName);
      setTimeout(loadNotes, 10);
    }

    async function loadSong(f) {
      const res = await fetch('/partitions/' + f);
      const base = await res.text();

      const personal = getPersonalSong(f);
      currentRaw = personal ? personal : base;

      transposeValue = 0;
      document.getElementById('transposeVal').innerText = "0";
      renderChordPro();
      renderGrids();          // ‚úÖ overlay grilles
      viewerElement.scrollTop = 0;
      updateBanner.style.display = 'none';
      updateVersionIndicator();
    }

    // --- SONG UPDATED ---
    function normName(s) {
      return String(s || '').trim().toLowerCase().replace(/\s+/g, ' ');
    }
    socket.on('song-updated', ({ fileName }) => {
      const viewerOpen = document.getElementById('viewer-container').style.display === 'block';
      if (!viewerOpen) return;
      const sameSong = normName(fileName) === normName(currentFileName);
      if (sameSong) updateBanner.style.display = 'flex';
    });

    function dismissUpdate() { updateBanner.style.display = 'none'; }
    function reloadCurrentSong() {
      stopAutoScroll();
      loadSong(currentFileName);
    }

    // --- NOTES ---
    function notesKey(fileName) {
      const u = currentUser || "unknown";
      return "notes:" + u + ":" + fileName;
    }
    function loadNotes() {
      if (!currentFileName) return;
      const val = localStorage.getItem(notesKey(currentFileName)) || "";
      notesTextarea.value = val;
    }
    function saveNotes() {
      if (!currentFileName) return;
      localStorage.setItem(notesKey(currentFileName), notesTextarea.value || "");
    }
    function toggleNotes() {
      const visible = notesPanel.style.display === "block";
      notesPanel.style.display = visible ? "none" : "block";
      if (!visible) loadNotes();
    }
    notesTextarea.addEventListener('input', saveNotes);

    // --- SYNCHRO SCROLL (anchres) ---
    function clamp01(x){ return Math.max(0, Math.min(1, x)); }

    function getTopLyricAnchorState() {
      const blocks = viewerElement.querySelectorAll('[data-kind="lyric"][data-anchor]');
      if (!blocks.length) return null;

      const st = viewerElement.scrollTop;
      for (const el of blocks) {
        const top = el.offsetTop;
        const h = el.offsetHeight || 1;
        if (top + h > st + 8) {
          const progress = clamp01((st - top) / h);
          return { anchor: el.dataset.anchor, progress };
        }
      }

      const last = blocks[blocks.length - 1];
      return { anchor: last.dataset.anchor, progress: 1 };
    }

    let lastEmitAt = 0;
    let lastEmitAnchor = "";
    let lastEmitProg = -1;

    viewerElement.addEventListener('scroll', () => {
      if (!isLeader || isRemoteScrolling) return;

      const state = getTopLyricAnchorState();
      if (!state) return;

      const now = Date.now();
      if (now - lastEmitAt < 80 &&
          state.anchor === lastEmitAnchor &&
          Math.abs(state.progress - lastEmitProg) < 0.03) {
        return;
      }

      lastEmitAt = now;
      lastEmitAnchor = state.anchor;
      lastEmitProg = state.progress;

      socket.emit('scroll-sync', state);
    });

    socket.on('apply-scroll', data => {
      if (isLeader) return;

      const anchor = data?.anchor;
      const progress = clamp01(Number(data?.progress) || 0);

      const el = anchor ? viewerElement.querySelector(`[data-kind="lyric"][data-anchor="${CSS.escape(anchor)}"]`) : null;

      isRemoteScrolling = true;

      if (el) {
        const top = el.offsetTop;
        const h = el.offsetHeight || 1;
        viewerElement.scrollTop = top + progress * h;
      } else {
        const max = viewerElement.scrollHeight - viewerElement.clientHeight;
        viewerElement.scrollTop = progress * (max > 0 ? max : 0);
      }

      setTimeout(() => { isRemoteScrolling = false; }, 50);
    });

    function isEditorOpen() {
      return document.getElementById('editor-container').style.display === 'block';
    }
    function isViewerOpen() {
      return document.getElementById('viewer-container').style.display === 'block';
    }

    viewerElement.addEventListener('touchstart', (e) => {
      if (!isViewerOpen() || isEditorOpen()) return;
      if (e.target && e.target.id === 'notesTextarea') return;

      const t = e.changedTouches[0];
      touchStartX = t.screenX;
      touchStartY = t.screenY;
    }, { passive: true });

    viewerElement.addEventListener('touchend', (e) => {
      if (!isViewerOpen() || isEditorOpen()) return;
      if (e.target && e.target.id === 'notesTextarea') return;

      const t = e.changedTouches[0];
      const dx = t.screenX - touchStartX;
      const dy = t.screenY - touchStartY;

      if (Math.abs(dx) < SWIPE_MIN_X) return;
      if (Math.abs(dx) < Math.abs(dy) * SWIPE_RATIO) return;

      if (dx > 0 && currentIndex > 0) openSong(currentIndex - 1);
      else if (dx < 0 && currentIndex < allSongs.length - 1) openSong(currentIndex + 1);
    }, { passive: true });

    // --- AUTO-SCROLL ---
    function sliderToPxPerSecond(value) {
      const v = Number(value) || 50;
      const delayMs = Math.max(10, 105 - v);
      return 1000 / delayMs;
    }

    function autoScrollLoop(t) {
      if (!isScrolling) return;

      if (!lastRafTime) lastRafTime = t;
      const dt = t - lastRafTime;
      lastRafTime = t;

      const pxPerSec = sliderToPxPerSecond(speedInput.value);
      const deltaPx = (dt / 1000) * pxPerSec;

      scrollCarry += deltaPx;
      const step = Math.floor(scrollCarry);

      if (step >= 1) {
        viewerElement.scrollTop += step;
        scrollCarry -= step;
      }

      rafId = requestAnimationFrame(autoScrollLoop);
    }

    function startAutoScroll() {
      if (isScrolling) return;
      isScrolling = true;
      document.getElementById('playBtn').innerText = "‚è∏";
      document.getElementById('playBtn').classList.add('active-btn');
      lastRafTime = 0;
      scrollCarry = 0;
      rafId = requestAnimationFrame(autoScrollLoop);
    }

    function stopAutoScroll() {
      if (!isScrolling) return;
      isScrolling = false;
      document.getElementById('playBtn').innerText = "‚ñ∂";
      document.getElementById('playBtn').classList.remove('active-btn');
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;
      lastRafTime = 0;
      scrollCarry = 0;
    }

    function toggleAutoScroll(emitSync) {
      if (isScrolling) stopAutoScroll();
      else startAutoScroll();

      if (isLeader && emitSync) {
        socket.emit('sync-autoscroll', { active: isScrolling, speed: speedInput.value });
      }
    }

    socket.on('apply-autoscroll', d => {
      if (!isLeader) {
        speedInput.value = d.speed;
        const wantActive = !!d.active;
        if (wantActive && !isScrolling) startAutoScroll();
        if (!wantActive && isScrolling) stopAutoScroll();
      }
    });

    // --- RENDU / POLICES / TRANSPOSITION ---
    function updateFontSize(delta) { fontSize += delta; renderChordPro(); renderGrids(); }
    function updateTranspose(dir) {
      transposeValue += dir;
      document.getElementById('transposeVal').innerText = (transposeValue > 0 ? '+' : '') + transposeValue;
      renderChordPro();
      renderGrids();
    }

    function toggleChordStyle() {
      chordStyle = (chordStyle === 'latin') ? 'american' : 'latin';
      localStorage.setItem('bandapp_chordStyle', chordStyle);
      syncSettingsUI();
      renderChordPro();
      renderGrids();
    }

    const scale = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const scaleLat = ['Do','Do#','R√©','R√©#','Mi','Fa','Fa#','Sol','Sol#','La','La#','Si'];

    function normalizeNote(note) {
      return note
        .replace('Bb','A#')
        .replace('Db','C#')
        .replace('Eb','D#')
        .replace('Gb','F#')
        .replace('Ab','G#');
    }

    function transChord(chord, steps) {
      return chord.replace(/([A-G][#b]?)/g, (match) => {
        const n = normalizeNote(match);
        const idx = scale.indexOf(n);
        if (idx === -1) return match;
        let newIdx = (idx + steps) % 12;
        if (newIdx < 0) newIdx += 12;
        return (chordStyle === 'latin' ? scaleLat[newIdx] : scale[newIdx]);
      });
    }

    function parseChordProLine(line) {
      let chordLine = '';
      let lyricLine = '';

      let i = 0;
      while (i < line.length) {
        const ch = line[i];

        if (ch === '[') {
          const end = line.indexOf(']', i);
          if (end !== -1) {
            const chordRaw = line.slice(i + 1, end);
            const chord = transChord(chordRaw, transposeValue);

            const pos = lyricLine.length;
            if (chordLine.length < pos) chordLine += ' '.repeat(pos - chordLine.length);

            chordLine = chordLine.slice(0, pos) + chord + chordLine.slice(pos + chord.length);

            i = end + 1;
            continue;
          }
        }

        lyricLine += ch;
        chordLine += (ch === '\t') ? '\t' : ' ';
        i++;
      }

      if (chordLine.length < lyricLine.length) chordLine += ' '.repeat(lyricLine.length - chordLine.length);
      return { chordLine, lyricLine };
    }

    function clearSongContent() { songContentEl.replaceChildren(); }

    function addCenteredTitle(text, level) {
      const el = document.createElement(level === 1 ? 'h1' : 'h2');
      el.style.textAlign = 'center';
      if (level === 2) el.style.color = (themeMode === 'light' ? '#555' : '#888');
      el.textContent = text;
      songContentEl.appendChild(el);
    }

    function addCommentLine(text, targetEl) {
      const wrap = document.createElement('div');
      wrap.className = 'commentwrap';

      const span = document.createElement('span');
      span.className = 'commentline';
      span.textContent = text;

      wrap.appendChild(span);
      targetEl.appendChild(wrap);
    }

    function addChordBlock(chordLine, lyricLine, targetEl, anchorId) {
      const block = document.createElement('div');
      block.className = 'block';
      block.style.fontSize = fontSize + 'px';

      block.dataset.kind = 'lyric';
      if (anchorId) block.dataset.anchor = anchorId;

      const preChord = document.createElement('pre');
      preChord.className = 'chordline';
      preChord.textContent = chordLine;

      const preLyric = document.createElement('pre');
      preLyric.className = 'lyricline';
      preLyric.textContent = lyricLine;

      if (chordLine.trim().length > 0) block.appendChild(preChord);
      block.appendChild(preLyric);

      targetEl.appendChild(block);
    }

    function normAnchorText(s){
      return String(s || "")
        .toLowerCase()
        .replace(/\s+/g, ' ')
        .trim();
    }

    function hashDJB2(str){
      let h = 5381;
      for (let i=0; i<str.length; i++) h = ((h << 5) + h) + str.charCodeAt(i);
      return (h >>> 0).toString(16);
    }

    function parsePUStart(line){
  // d√©tecte {pu:Nemo}
  const m = line.match(/^\{pu\s*:\s*([^}]+)\}$/i);
  if (!m) return null;

  return {
    user: m[1].trim()
  };
}

function renderPUBlock(targetEl, showContent, label, text){
  const wrap = document.createElement('div');
  wrap.className = 'pu-block';

  const linesCount = (String(text || "").split('\n').length);

  if (showContent) {
    // ‚úÖ label seulement pour la personne concern√©e
    const lab = document.createElement('div');
    lab.className = 'pu-label';
    lab.textContent = label;
    wrap.appendChild(lab);
  } else {
    // ‚úÖ pour les autres : si > 10 lignes, afficher un indicateur "SOLO <user>"
    if (linesCount > 10) {
      const lab = document.createElement('div');
      lab.className = 'pu-label';
      lab.textContent = `SOLO ${label}`;
      wrap.appendChild(lab);
    }
  }

  const pre = document.createElement('pre');
  pre.className = 'pu-pre';

  if (showContent) {
    pre.textContent = text || "";
  } else {
    // m√™me nombre de lignes, mais vides
    pre.textContent = Array.from({ length: linesCount }, () => " ").join("\n");
  }

  wrap.appendChild(pre);
  targetEl.appendChild(wrap);
}

    function renderChordPro() {
      clearSongContent();
      renderChordPro._occ = {};

      // ‚úÖ layer overlays (grilles perso)
      const overlayLayer = document.createElement('div');
      overlayLayer.id = 'overlayLayer';
      songContentEl.appendChild(overlayLayer);

      let inChorus = false;
      let chorusContainer = null;
      let inPU = false;
let puUser = "";
let puBuffer = [];

      const lines = currentRaw.split('\n');

      for (const line of lines) {
        const target = (inChorus && chorusContainer) ? chorusContainer : songContentEl;
        // ===== Bloc personnel START =====
if (!inPU) {
  const start = parsePUStart(line.trim());
  if (start) {
    inPU = true;
    puUser = start.user;
    puBuffer = [];
    continue;
  }
} else {
  // ===== Bloc personnel END =====
  if (/^\{\/pu\s*\}$/i.test(line.trim())) {

    const show = (currentUser || "").toLowerCase() === puUser.toLowerCase();
    const txt = puBuffer.join("\n");

    renderPUBlock(target, show, puUser, txt);

    inPU = false;
    puUser = "";
    puBuffer = [];
    continue;
  }

  puBuffer.push(line);
  continue;
}

        const title = line.match(/\{(?:t|title)\s*:\s*(.*?)\}/i);
        if (title) { addCenteredTitle(title[1], 1); continue; }

        const subtitle = line.match(/\{(?:st|subtitle)\s*:\s*(.*?)\}/i);
        if (subtitle) { addCenteredTitle(subtitle[1], 2); continue; }

        if (/\{soc\s*:\s*\}/i.test(line) || /\{soc\s*\}/i.test(line)) {
          inChorus = true;
          chorusContainer = document.createElement('div');
          chorusContainer.className = 'chorus-block';
          songContentEl.appendChild(chorusContainer);
          continue;
        }
        if (/\{eoc\s*:\s*\}/i.test(line) || /\{eoc\s*\}/i.test(line)) {
          inChorus = false;
          chorusContainer = null;
          continue;
        }

        const comment = line.match(/\{c\s*:\s*(.*?)\}/i);
        if (comment) {
          addCommentLine(comment[1], target);
          continue;
        }

        const { chordLine, lyricLine } = parseChordProLine(line);

        const key = normAnchorText(lyricLine);
        renderChordPro._occ[key] = (renderChordPro._occ[key] || 0) + 1;
        const anchorId = hashDJB2(key) + "-" + renderChordPro._occ[key];

        addChordBlock(chordLine, lyricLine, target, anchorId);
      }
    }

    // --- SOCKETS ---
    socket.on('load-song', f => {
      if (!isLeader) {
        const idx = allSongs.indexOf(f);
        if (idx !== -1) openSong(idx);
      }
    });

    // --- EDIT UI ---
    function openEditChoice() { document.getElementById('editChoiceBackdrop').style.display = 'flex'; }
    function closeEditChoice() { document.getElementById('editChoiceBackdrop').style.display = 'none'; }
    function openEditor() { stopAutoScroll(); openEditChoice(); }

    // Perso : partition perso compl√®te, stock√©e localement (PAR UTILISATEUR)
    function personalSongKey(fileName) {
      const u = currentUser || "unknown";
      return `personalSong:${u}:${fileName}`;
    }
    function getPersonalSong(fileName) { return localStorage.getItem(personalSongKey(fileName)) || ""; }
    function setPersonalSong(fileName, content) { localStorage.setItem(personalSongKey(fileName), content || ""); }

    async function chooseEditMode(mode) {
      editMode = mode;
      closeEditChoice();

      if (mode === 'personal') {
        globalPinCache = "";
        startEditorWithMode('personal');
        return;
      }

      let pin = prompt("PIN requis pour modifier pour tout le monde (ex: 1991)") || "";
      pin = String(pin).trim();

      if (!pin) {
        editMode = null;
        globalPinCache = "";
        return;
      }

      globalPinCache = pin;
      startEditorWithMode('global');
    }

    async function startEditorWithMode(mode) {
  const ta = document.getElementById('editor-textarea');

  if (mode === "personal") {
    const personal = getPersonalSong(currentFileName);
    ta.value = personal || currentRaw;
  } else {
    const res = await fetch('/partitions/' + currentFileName);
    ta.value = await res.text();
  }

  document.getElementById('editor-container').style.display = 'block';

  // ‚úÖ Toujours activer la banque d'accords
  setTimeout(() => {
    renderChordBankFromEditor();
    ta.addEventListener('input', renderChordBankFromEditor);
  }, 0);
}

function closeEditor() {
  const ta = document.getElementById('editor-textarea');
  if (ta) ta.removeEventListener('input', renderChordBankFromEditor);

  document.getElementById('editor-container').style.display = 'none';
}

    async function saveEditor() {
      const newContent = document.getElementById('editor-textarea').value;
      if (!currentFileName) return;

      if (editMode === "personal") {
        setPersonalSong(currentFileName, newContent);
        currentRaw = newContent;
        renderChordPro();
        renderGrids();
        closeEditor();
        updateVersionIndicator();
        return;
      }

      const pin = String(globalPinCache || "").trim();
      if (!pin) {
        alert("PIN manquant. Recommence et choisis 'pour tout le monde'.");
        return;
      }

      const res = await fetch('/save-song', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fileName: currentFileName, content: newContent, pin })
      });

      if (res.ok) {
        currentRaw = newContent;
        renderChordPro();
        renderGrids();
        closeEditor();

        if (isLeader) socket.emit('change-song', currentFileName);

      } else if (res.status === 403) {
        alert("PIN invalide");
        globalPinCache = "";
        editMode = null;
      } else {
        alert("Erreur d'enregistrement");
      }
    }

    function closeViewer() {
      stopAutoScroll();
      notesPanel.style.display = 'none';
      document.getElementById('library').style.display = 'block';
      document.getElementById('viewer-container').style.display = 'none';
    }

    // === GRILLES PERSO "SOUS LA LIGNE" (overlay, par utilisateur + par chanson) ===
    function gridsKey(fileName){
      const u = currentUser || "unknown";
      return `grids:${u}:${fileName}`;
    }

    function loadGrids(fileName){
      try {
        const raw = localStorage.getItem(gridsKey(fileName)) || "[]";
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    function saveGrids(fileName, arr){
      localStorage.setItem(gridsKey(fileName), JSON.stringify(arr || []));
    }

    function renderGrids(){
      if (!currentFileName) return;

      const layer = document.getElementById('overlayLayer');
      if (!layer) return;
      layer.innerHTML = "";

      const grids = loadGrids(currentFileName);

      for (const g of grids){
        const anchor = g?.anchor;
        const text = String(g?.text || "").trim();
        if (!anchor || !text) continue;

        const el = viewerElement.querySelector(
          `[data-kind="lyric"][data-anchor="${CSS.escape(anchor)}"]`
        );
        if (!el) continue;

        const top = el.offsetTop + el.offsetHeight + 6;

        const wrap = document.createElement('div');
        wrap.className = 'gridOverlay';
        wrap.style.top = top + "px";

        const box = document.createElement('div');
        box.className = 'box';
        box.textContent = text;

        wrap.appendChild(box);
        layer.appendChild(wrap);
      }
    }

    function addGridUnderCurrentLine(){
      if (!currentFileName) { showToast("Aucune chanson ouverte"); return; }

      const state = getTopLyricAnchorState?.();
      if (!state?.anchor) { showToast("Impossible de trouver une ligne"); return; }

      const txt = prompt("Grille √† afficher sous cette ligne (ex: Am | F | C | G)") || "";
      const clean = String(txt).trim();
      if (!clean) return;

      const grids = loadGrids(currentFileName);
      grids.push({ anchor: state.anchor, text: clean });

      saveGrids(currentFileName, grids);
      renderGrids();
      showToast("Grille ajout√©e ‚úÖ");
    }

    // --- BACKUP EXPORT / IMPORT ---
    const BACKUP_PREFIXES = ['bandapp_', 'personalSong:', 'notes:', 'overlay:', 'grids:'];

    function isBackupKey(k) {
      return BACKUP_PREFIXES.some(p => k.startsWith(p));
    }

    function exportBackup() {
      try {
        const data = {};
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (!key) continue;
          if (!isBackupKey(key)) continue;
          data[key] = localStorage.getItem(key);
        }

        const payload = {
          app: "bandapp",
          schemaVersion: 1,
          exportedAt: new Date().toISOString(),
          data
        };

        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const filename = `bandapp-backup-${y}-${m}-${day}.json`;

        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();

        URL.revokeObjectURL(url);
        showToast("Sauvegarde export√©e ‚úÖ");
      } catch (e) {
        console.error(e);
        alert("Erreur export sauvegarde");
      }
    }

    function triggerImport() {
      closeSettings();
      const input = document.getElementById('importFile');
      if (!input) return;
      input.value = "";
      setTimeout(() => input.click(), 80);
    }

    function handleImportFile(event) {
      const file = event?.target?.files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const txt = String(reader.result || "");
          const json = JSON.parse(txt);

          if (!json || json.app !== "bandapp" || typeof json.data !== "object") {
            alert("Fichier de sauvegarde invalide.");
            return;
          }

          const keys = Object.keys(json.data);
          for (const k of keys) {
            localStorage.setItem(k, json.data[k]);
          }

          showToast("Sauvegarde import√©e ‚úÖ");
          setTimeout(() => location.reload(), 600);

        } catch (e) {
          console.error(e);
          alert("Erreur : impossible d'importer la sauvegarde.");
        }
      };
      reader.readAsText(file);
    }

    function insertAtCursor(text){
  const ta = document.getElementById('editor-textarea');
  if (!ta) return;

  const start = ta.selectionStart || 0;
  const end = ta.selectionEnd || 0;

  ta.value =
    ta.value.substring(0, start) +
    text +
    ta.value.substring(end);

  ta.selectionStart = ta.selectionEnd = start + text.length;
  ta.focus();
}

function insertTemplatePU(){
  const u = currentUser || "Nom";
  insertAtCursor(`{pu:${u}}\n\n{/pu}\n`);
}

function insertTemplateComment(){
  insertAtCursor(`{c: }\n`);
}

function extractChordsFromText(text){
  const set = new Set();
  const re = /\[([^\]]+)\]/g;
  let m;
  while ((m = re.exec(text)) !== null){
    set.add(m[1].trim());
  }
  return Array.from(set);
}

function renderChordBankFromEditor(){
  const bank = document.getElementById('chordBank');
  const ta = document.getElementById('editor-textarea');
  if (!bank || !ta) return;

  const chords = extractChordsFromText(ta.value);

  if (!chords.length){
    bank.innerHTML = "";
    return;
  }

  bank.innerHTML =
    "<span style='opacity:.5;font-size:12px;'>Accords:</span>" +
    chords.map(c =>
      `<button class="btn" style="padding:6px 10px;font-size:12px;" onclick="insertAtCursor('[${c}]')">${c}</button>`
    ).join('');
}

    // --- INIT ---
    applyTheme();
    initUsers();
    fetchSongs();
    syncSettingsUI();
  </script>
</body>
</html>