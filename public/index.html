<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>BandApp Pro - Live Sync</title>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <style>
    :root { --bg: #000; --text: #eee; --accent: #ff9800; --edit: #2196F3; }
    body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow: hidden; overscroll-behavior-x: none; }

    #library { height: 100vh; overflow-y: auto; display: block; -webkit-overflow-scrolling: touch; }
    .lib-header { padding: 20px; background: #1a1a1a; border-bottom: 2px solid var(--accent); display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; z-index: 5; gap: 10px; }
    .song-item { padding: 20px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; font-size: 1.1em; cursor: pointer; }
    .user-chip { display:flex; align-items:center; gap:8px; background:#222; border:1px solid #333; padding:8px 10px; border-radius:999px; font-size:12px; }
    .user-chip b { font-size: 12px; color: #fff; }
    .user-chip button { padding:6px 10px; border-radius:999px; font-size:12px; }

    #viewer-container { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: var(--bg); z-index: 10; }
    nav { display: flex; background: #1a1a1a; min-height: 60px; align-items: center; padding: 0 10px; gap: 8px; border-bottom: 1px solid #333; flex-wrap: wrap; }
    .controls-group { display:flex; align-items:center; gap:5px; background:#222; padding:5px; border-radius:8px; }

    #updateBanner {
      position: sticky; top: 0; z-index: 999; display: none;
      background: #222; border-bottom: 1px solid #444; padding: 10px 12px;
      font-size: 14px; align-items: center; justify-content: space-between; gap: 10px;
    }
    #updateBanner .msg { color: #ddd; }
    #updateBanner .btn-small { padding: 8px 10px; border-radius: 6px; font-size: 12px; }

    #notesPanel {
      display: none; position: sticky; top: 0; z-index: 998;
      background: #111; border-bottom: 1px solid #333; padding: 10px 12px; gap: 10px;
    }
    #notesPanel textarea {
      width: 100%; height: 110px; background: #000; color: #ddd;
      border: 1px solid #333; border-radius: 8px;
      font-family: monospace; font-size: 14px; padding: 10px; box-sizing: border-box; resize: none;
    }
    .notes-row { display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap: wrap; }
    .note-hint { color:#aaa; font-size:12px; }

    #viewer {
      height: calc(100vh - 65px);
      overflow-y: scroll;
      padding: 25px;
      font-family: 'Courier New', Courier, monospace;
      -webkit-overflow-scrolling: touch;
      scroll-behavior: auto !important;
      touch-action: pan-y;
    }

    .block { margin-bottom: 26px; }
    .chordline, .lyricline { white-space: pre; line-height: 1.6; margin: 0; }
    .chordline { color: var(--accent); font-weight: bold; }

    #editor-container { display: none; position: fixed; top: 60px; left: 0; width: 100vw; height: calc(100vh - 60px); background: #111; z-index: 20; }
    #editor-textarea { width: 100%; height: 80%; background: #000; color: #2196F3; border: none; font-family: monospace; font-size: 16px; padding: 20px; box-sizing: border-box; }
    .editor-footer { height: 20%; display: flex; justify-content: center; align-items: center; gap: 20px; background: #1a1a1a; }

    .btn { cursor: pointer; padding: 10px 14px; border: 2px solid var(--accent); border-radius: 6px; color: var(--accent); background: none; font-size: 13px; font-weight: bold; }
    .btn-blue { border-color: var(--edit); color: var(--edit); }
    .leader-mode { background: var(--accent) !important; color: #000 !important; }
    .active-btn { background: #444; color: #fff; }
    .disabled { opacity: 0.5; pointer-events: none; }

    /* -------- Modals -------- */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 18px;
    }
    .modal {
      width: min(520px, 100%);
      background: #121212;
      border: 1px solid #2a2a2a;
      border-radius: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      overflow: hidden;
    }
    .modal header {
      padding: 14px 16px;
      border-bottom: 1px solid #2a2a2a;
      display:flex; justify-content:space-between; align-items:center;
      background:#161616;
    }
    .modal header h3 { margin:0; font-size: 14px; color:#fff; }
    .modal .content { padding: 14px 16px; }
    .modal .row { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    .modal input, .modal select {
      width: 100%;
      background: #000;
      color: #eee;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .modal .actions { padding: 14px 16px; border-top: 1px solid #2a2a2a; display:flex; gap:10px; justify-content:flex-end; }
    .pill {
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 12px; border-radius: 12px;
      border: 1px solid #333; background:#0b0b0b;
      cursor: pointer;
      user-select: none;
    }
    .pill:hover { background:#101010; }
    .pill b { color:#fff; font-size: 14px; }
    .small { color:#aaa; font-size: 12px; }
  </style>
</head>

<body>

  <!-- USER MODAL -->
  <div id="userModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <header>
        <h3>Choisir un utilisateur</h3>
      </header>
      <div class="content">
        <div class="small" style="margin-bottom:10px;">
          Les notes et r√©glages (taille, transpo) seront li√©s √† cet utilisateur sur cet appareil.
        </div>

        <div id="userList" style="display:flex; flex-direction:column; gap:10px;"></div>

        <div style="margin-top:14px; border-top:1px solid #2a2a2a; padding-top:14px;">
          <div class="small" style="margin-bottom:8px;">Ajouter un utilisateur</div>
          <div class="row">
            <input id="newUserInput" placeholder="Nom (ex: Nemo)" />
            <button class="btn btn-blue" onclick="addUser()">AJOUTER</button>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" onclick="closeUserModal()" style="border-color:#777;color:#777;">PLUS TARD</button>
      </div>
    </div>
  </div>

  <!-- PIN MODAL -->
  <div id="pinModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <header>
        <h3 id="pinTitle">Code requis</h3>
      </header>
      <div class="content">
        <div class="small" id="pinHint" style="margin-bottom:10px;">Entrez le code pour continuer.</div>
        <input id="pinInput" type="password" inputmode="numeric" placeholder="PIN" />
      </div>
      <div class="actions">
        <button class="btn" onclick="cancelPin()" style="border-color:#777;color:#777;">ANNULER</button>
        <button class="btn btn-blue" onclick="confirmPin()">OK</button>
      </div>
    </div>
  </div>

  <div id="library">
    <div class="lib-header">
      <div style="display:flex; flex-direction:column; gap:6px;">
        <h2 style="margin:0;">R√©pertoire</h2>
        <div class="small">Synchro: d√©filement leader (Option A) + r√©glages/notes perso</div>
      </div>

      <div style="display:flex; gap:10px; align-items:center;">
        <div class="user-chip" title="Utilisateur courant">
          <span>üë§</span>
          <b id="currentUserLabel">‚Äî</b>
          <button class="btn" style="padding:6px 10px;" onclick="openUserModal()">Changer</button>
        </div>

        <button class="btn" id="libLeaderBtn" onclick="toggleLeader()">Mode Solo</button>
      </div>
    </div>
    <div id="songList"></div>
  </div>

  <div id="viewer-container">
    <nav>
      <button class="btn" onclick="closeViewer()">‚¨Ö</button>

      <div class="controls-group">
        <button class="btn" id="playBtn" onclick="toggleAutoScroll(true)">‚ñ∂</button>
        <input type="range" id="scrollSpeed" min="1" max="95" value="50">
      </div>

      <div class="controls-group">
        <button class="btn" onclick="updateFontSize(-2)">A-</button>
        <button class="btn" onclick="updateFontSize(2)">A+</button>
      </div>

      <div class="controls-group">
        <button class="btn" onclick="updateTranspose(-1)">-</button>
        <span id="transposeVal" style="min-width:20px; text-align:center">0</span>
        <button class="btn" onclick="updateTranspose(1)">+</button>
      </div>

      <button class="btn" id="notesBtn" onclick="toggleNotes()">NOTES</button>
      <button class="btn btn-blue" onclick="openEditor()">√âDITER</button>
      <button class="btn" id="navLeaderBtn" onclick="toggleLeader()">Solo</button>
    </nav>

    <div id="updateBanner">
      <div class="msg">Une mise √† jour de cette chanson est disponible.</div>
      <div style="display:flex; gap:8px;">
        <button class="btn btn-small" onclick="dismissUpdate()">PLUS TARD</button>
        <button class="btn btn-blue btn-small" onclick="reloadCurrentSong()">RECHARGER</button>
      </div>
    </div>

    <div id="notesPanel">
      <div class="notes-row">
        <div class="note-hint">Notes personnelles (ne modifie pas la partition globale)</div>
        <button class="btn btn-small" onclick="clearNotes()" style="border-color:#ff5252;color:#ff5252;">EFFACER</button>
      </div>
      <textarea id="notesTextarea" placeholder="Ex: Refrain 2: attention au break / Entr√©e basse apr√®s 2 temps / etc."></textarea>
      <div class="note-hint">Sauvegarde auto pour l‚Äôutilisateur s√©lectionn√©.</div>
    </div>

    <div id="viewer">
      <div id="songContent"></div>
      <div style="height: 85vh;"></div>
    </div>
  </div>

  <div id="editor-container">
    <textarea id="editor-textarea" spellcheck="false"></textarea>
    <div class="editor-footer">
      <button class="btn" onclick="closeEditor()" style="border-color: #ff5252; color: #ff5252;">ANNULER</button>
      <button class="btn btn-blue" onclick="saveEditor()">ENREGISTRER</button>
    </div>
  </div>

  <script>
    const socket = io();

// ------------------ USERS ------------------

const defaultUsers = [
  "Nemo",
  "Estelle",
  "Gillou",
  "Bubu",
  "Christian",
  "Christophe"
];

const USERS_KEY = "bandapp_users";
const USERS_VER_KEY = "bandapp_users_version";
const CURRENT_USER_KEY = "bandapp_current_user";

// üî¥ IMPORTANT : augmente ce num√©ro si tu modifies la liste plus tard
const USERS_VERSION = 2;

function loadUsers() {
  const storedVer = Number(localStorage.getItem(USERS_VER_KEY) || "0");
  const raw = localStorage.getItem(USERS_KEY);

  // Si version diff√©rente ‚Üí on √©crase avec la nouvelle liste
  if (storedVer !== USERS_VERSION) {
    localStorage.setItem(USERS_KEY, JSON.stringify(defaultUsers));
    localStorage.setItem(USERS_VER_KEY, String(USERS_VERSION));
    return [...defaultUsers];
  }

  if (raw) {
    try {
      const arr = JSON.parse(raw);
      if (Array.isArray(arr) && arr.length) return arr;
    } catch {}
  }

  localStorage.setItem(USERS_KEY, JSON.stringify(defaultUsers));
  localStorage.setItem(USERS_VER_KEY, String(USERS_VERSION));
  return [...defaultUsers];
}

function saveUsers(list) {
  localStorage.setItem(USERS_KEY, JSON.stringify(list));
  localStorage.setItem(USERS_VER_KEY, String(USERS_VERSION));
}

function getCurrentUser() {
  return localStorage.getItem(CURRENT_USER_KEY) || "";
}

function setCurrentUser(name) {
  localStorage.setItem(CURRENT_USER_KEY, name);
  document.getElementById("currentUserLabel").textContent = name || "‚Äî";
  loadUserPrefs();
  loadNotesForSong(currentFileName);
}


    function openUserModal() {
      renderUserList();
      document.getElementById("userModalBackdrop").style.display = "flex";
    }

    function closeUserModal() {
      document.getElementById("userModalBackdrop").style.display = "none";
    }

    function renderUserList() {
      const users = loadUsers();
      const container = document.getElementById("userList");
      container.replaceChildren();

      users.forEach(u => {
        const pill = document.createElement("div");
        pill.className = "pill";
        pill.innerHTML = `<b>${escapeHtml(u)}</b><span class="small">S√©lectionner</span>`;
        pill.onclick = () => {
          setCurrentUser(u);
          closeUserModal();
        };
        container.appendChild(pill);
      });
    }

    function addUser() {
      const input = document.getElementById("newUserInput");
      const name = (input.value || "").trim();
      if (!name) return;

      const users = loadUsers();
      if (!users.includes(name)) {
        users.push(name);
        users.sort((a,b) => a.localeCompare(b));
        saveUsers(users);
      }
      input.value = "";
      renderUserList();
    }

    // ------------------ PIN MODAL ------------------
    let leaderPin = localStorage.getItem('leaderPin') || '';
    let pinResolve = null;
    let pinReject = null;

    function openPinModal(title, hint) {
      document.getElementById("pinTitle").textContent = title || "Code requis";
      document.getElementById("pinHint").textContent = hint || "Entrez le code pour continuer.";
      const inp = document.getElementById("pinInput");
      inp.value = "";
      document.getElementById("pinModalBackdrop").style.display = "flex";
      setTimeout(() => inp.focus(), 50);

      return new Promise((resolve, reject) => {
        pinResolve = resolve;
        pinReject = reject;
      });
    }

    function cancelPin() {
      document.getElementById("pinModalBackdrop").style.display = "none";
      if (pinReject) pinReject(new Error("cancel"));
      pinResolve = null; pinReject = null;
    }

    function confirmPin() {
      const v = (document.getElementById("pinInput").value || "").trim();
      document.getElementById("pinModalBackdrop").style.display = "none";
      if (pinResolve) pinResolve(v);
      pinResolve = null; pinReject = null;
    }

    async function requirePinUI(title, hint) {
      if (leaderPin && leaderPin.length > 0) return leaderPin;
      const p = await openPinModal(title, hint).catch(() => "");
      if (!p) return "";
      leaderPin = p;
      localStorage.setItem("leaderPin", leaderPin);
      return leaderPin;
    }

    function clearStoredPin() {
      leaderPin = "";
      localStorage.removeItem("leaderPin");
    }

    // ------------------ STATE ------------------
    let isLeader = false, allSongs = [], currentIndex = -1;
    let currentRaw = "", currentFileName = "";

    // prefs per-user
    let fontSize = 26;
    let transposeValue = 0;

    let isRemoteScrolling = false;

    // Auto-scroll leader local
    let isScrolling = false;
    let rafId = null;
    let lastRafTime = 0;
    let scrollCarry = 0;

    // follower: leader play ?
    let leaderIsPlaying = false;

    const viewerElement = document.getElementById('viewer');
    const songContentEl = document.getElementById('songContent');
    const speedInput = document.getElementById('scrollSpeed');

    const updateBanner = document.getElementById('updateBanner');

    const notesPanel = document.getElementById('notesPanel');
    const notesTextarea = document.getElementById('notesTextarea');
    const notesBtn = document.getElementById('notesBtn');

    socket.on('connect', () => { document.getElementById('navLeaderBtn').style.borderColor = "#4CAF50"; });
    socket.on('disconnect', () => { document.getElementById('navLeaderBtn').style.borderColor = "#f44336"; });

    function normName(s) { return String(s || '').trim().toLowerCase().replace(/\s+/g, ' '); }
    function isEditorOpen() { return document.getElementById('editor-container').style.display === 'block'; }
    function isViewerOpen() { return document.getElementById('viewer-container').style.display === 'block'; }

    // ------------------ PREFS / NOTES (per user) ------------------
    function prefsKey() {
      const u = getCurrentUser() || "anonymous";
      return `prefs:${u}`;
    }

    function loadUserPrefs() {
      const raw = localStorage.getItem(prefsKey());
      if (raw) {
        try {
          const p = JSON.parse(raw);
          fontSize = Number(p.fontSize ?? 26) || 26;
          transposeValue = Number(p.transpose ?? 0) || 0;
        } catch {
          fontSize = 26; transposeValue = 0;
        }
      } else {
        fontSize = 26; transposeValue = 0;
      }
      document.getElementById('transposeVal').innerText = (transposeValue > 0 ? '+' : '') + transposeValue;
      if (currentRaw) renderChordPro();
    }

    function saveUserPrefs() {
      const u = getCurrentUser() || "anonymous";
      localStorage.setItem(`prefs:${u}`, JSON.stringify({ fontSize, transpose: transposeValue }));
    }

    function notesKeyForSong(fileName) {
      const u = getCurrentUser() || "anonymous";
      return `notes:${u}:${fileName}`;
    }

    function loadNotesForSong(fileName) {
      if (!fileName) return;
      notesTextarea.value = localStorage.getItem(notesKeyForSong(fileName)) || '';
      updateNotesBtn();
    }

    function saveNotesForSong(fileName) {
      if (!fileName) return;
      localStorage.setItem(notesKeyForSong(fileName), notesTextarea.value || '');
      updateNotesBtn();
    }

    function updateNotesBtn() {
      const has = (notesTextarea.value || '').trim().length > 0;
      notesBtn.classList.toggle('active-btn', has);
    }

    let notesTimer = null;
    notesTextarea.addEventListener('input', () => {
      updateNotesBtn();
      clearTimeout(notesTimer);
      notesTimer = setTimeout(() => saveNotesForSong(currentFileName), 250);
    });

    function toggleNotes() { notesPanel.style.display = (notesPanel.style.display === 'block') ? 'none' : 'block'; }
    function clearNotes() { notesTextarea.value = ''; saveNotesForSong(currentFileName); }

    // ------------------ Library ------------------
    async function fetchSongs() {
      const res = await fetch('/list-songs');
      allSongs = (await res.json()).sort();
      document.getElementById('songList').innerHTML = allSongs.map((s, idx) => `
        <div class="song-item" onclick="openSong(${idx})">
          <b>${s.replace('.pro','').replace('.cho','')}</b><span>‚ùØ</span>
        </div>`).join('');
    }

    function refreshControlsLock() {
      const playBtn = document.getElementById('playBtn');
      const lock = (!isLeader && leaderIsPlaying);
      playBtn.classList.toggle('disabled', lock);
    }

    async function toggleLeader() {
      const next = !isLeader;

      if (next) {
        const pin = await requirePinUI("PIN Leader", "Entrez le PIN pour activer le mode Leader.");
        if (!pin) return; // annul√©
      } else {
        stopAutoScroll();
      }

      isLeader = next;
      const btns = [document.getElementById('libLeaderBtn'), document.getElementById('navLeaderBtn')];
      btns.forEach(btn => {
        btn.classList.toggle('leader-mode', isLeader);
        btn.innerText = isLeader ? "Mode Leader" : "Mode Solo";
      });

      refreshControlsLock();
    }

    async function openSong(idx) {
      if (idx < 0 || idx >= allSongs.length) return;
      currentIndex = idx;
      currentFileName = allSongs[idx];

      updateBanner.style.display = 'none';
      document.getElementById('library').style.display = 'none';
      document.getElementById('viewer-container').style.display = 'block';

      loadNotesForSong(currentFileName);

      if (isLeader) {
        const pin = await requirePinUI("PIN Leader", "PIN requis pour synchroniser les autres appareils.");
        if (!pin) return;
        socket.emit('change-song', { fileName: currentFileName, pin });
      }

      await loadSong(currentFileName);
    }

    async function loadSong(f) {
      const res = await fetch('/partitions/' + f);
      currentRaw = await res.text();
      renderChordPro();
      viewerElement.scrollTop = 0;
      updateBanner.style.display = 'none';
    }

    // ------------------ Update banner ------------------
    socket.on('song-updated', ({ fileName }) => {
      if (!isViewerOpen()) return;
      if (normName(fileName) === normName(currentFileName)) {
        updateBanner.style.display = 'flex';
      }
    });
    function dismissUpdate() { updateBanner.style.display = 'none'; }
    function reloadCurrentSong() { stopAutoScroll(); loadSong(currentFileName); }

    // ------------------ Option A: sync scroll position ------------------
    let lastEmitAt = 0, lastEmitPos = -1;
    viewerElement.addEventListener('scroll', async () => {
      if (!isLeader || isRemoteScrolling) return;

      const max = viewerElement.scrollHeight - viewerElement.clientHeight;
      const pos = max > 0 ? (viewerElement.scrollTop / max) : 0;

      const now = Date.now();
      if (now - lastEmitAt < 60 && Math.abs(pos - lastEmitPos) < 0.002) return;

      lastEmitAt = now;
      lastEmitPos = pos;

      const pin = await requirePinUI("PIN Leader", "PIN requis pour synchroniser le d√©filement.");
      if (!pin) return;
      socket.emit('scroll-sync', { pos, pin });
    });

    socket.on('apply-scroll', (p) => {
      if (isLeader) return;
      isRemoteScrolling = true;
      const max = viewerElement.scrollHeight - viewerElement.clientHeight;
      viewerElement.scrollTop = (Number(p) || 0) * (max > 0 ? max : 0);
      setTimeout(() => { isRemoteScrolling = false; }, 40);
    });

    // ------------------ Leader autoscroll local ------------------
    function sliderToPxPerSecond(value) {
      const v = Number(value) || 50;
      const delayMs = Math.max(10, 105 - v);
      return 1000 / delayMs;
    }

    function autoScrollLoop(t) {
      if (!isScrolling) return;
      if (!lastRafTime) lastRafTime = t;
      const dt = t - lastRafTime;
      lastRafTime = t;

      const pxPerSec = sliderToPxPerSecond(speedInput.value);
      const deltaPx = (dt / 1000) * pxPerSec;

      scrollCarry += deltaPx;
      const step = Math.floor(scrollCarry);
      if (step >= 1) {
        viewerElement.scrollTop += step;
        scrollCarry -= step;
      }
      rafId = requestAnimationFrame(autoScrollLoop);
    }

    function startAutoScroll() {
      if (isScrolling) return;
      isScrolling = true;
      document.getElementById('playBtn').innerText = "‚è∏";
      document.getElementById('playBtn').classList.add('active-btn');
      lastRafTime = 0; scrollCarry = 0;
      rafId = requestAnimationFrame(autoScrollLoop);
    }

    function stopAutoScroll() {
      if (!isScrolling) return;
      isScrolling = false;
      document.getElementById('playBtn').innerText = "‚ñ∂";
      document.getElementById('playBtn').classList.remove('active-btn');
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null; lastRafTime = 0; scrollCarry = 0;
    }

    async function toggleAutoScroll(emitSync) {
      if (!isLeader && leaderIsPlaying) return;

      if (isScrolling) stopAutoScroll();
      else startAutoScroll();

      if (isLeader && emitSync) {
        const pin = await requirePinUI("PIN Leader", "PIN requis pour annoncer Play/Pause.");
        if (!pin) return;
        socket.emit('sync-autoscroll', { active: isScrolling, pin });
      }
    }

    socket.on('apply-autoscroll', (d) => {
      if (isLeader) return;
      leaderIsPlaying = !!d.active;
      if (leaderIsPlaying) stopAutoScroll();
      refreshControlsLock();
    });

    // ------------------ Swipe ------------------
    let touchStartX = 0, touchStartY = 0;
    const SWIPE_MIN_X = 110, SWIPE_RATIO = 1.4;

    viewerElement.addEventListener('touchstart', (e) => {
      if (!isViewerOpen() || isEditorOpen()) return;
      const t = e.changedTouches[0];
      touchStartX = t.screenX; touchStartY = t.screenY;
    }, { passive: true });

    viewerElement.addEventListener('touchend', (e) => {
      if (!isViewerOpen() || isEditorOpen()) return;
      const t = e.changedTouches[0];
      const dx = t.screenX - touchStartX;
      const dy = t.screenY - touchStartY;
      if (Math.abs(dx) < SWIPE_MIN_X) return;
      if (Math.abs(dx) < Math.abs(dy) * SWIPE_RATIO) return;
      if (dx > 0 && currentIndex > 0) openSong(currentIndex - 1);
      else if (dx < 0 && currentIndex < allSongs.length - 1) openSong(currentIndex + 1);
    }, { passive: true });

    // ------------------ Personal prefs ------------------
    function updateFontSize(delta) {
      fontSize += delta;
      saveUserPrefs();
      renderChordPro();
    }

    function updateTranspose(dir) {
      transposeValue += dir;
      saveUserPrefs();
      document.getElementById('transposeVal').innerText = (transposeValue > 0 ? '+' : '') + transposeValue;
      renderChordPro();
    }

    // ------------------ ChordPro rendering ------------------
    const scale = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const scaleLat = ['Do','Do#','R√©','R√©#','Mi','Fa','Fa#','Sol','Sol#','La','La#','Si'];

    function normalizeNote(note) {
      return note.replace('Bb','A#').replace('Db','C#').replace('Eb','D#').replace('Gb','F#').replace('Ab','G#');
    }
    function transChord(chord, steps) {
      return chord.replace(/([A-G][#b]?)/g, (match) => {
        const n = normalizeNote(match);
        const idx = scale.indexOf(n);
        if (idx === -1) return match;
        let newIdx = (idx + steps) % 12;
        if (newIdx < 0) newIdx += 12;
        return scaleLat[newIdx];
      });
    }

    function parseChordProLine(line) {
      let chordLine = '', lyricLine = '';
      let i = 0;
      while (i < line.length) {
        const ch = line[i];
        if (ch === '[') {
          const end = line.indexOf(']', i);
          if (end !== -1) {
            const chordRaw = line.slice(i + 1, end);
            const chord = transChord(chordRaw, transposeValue);
            const pos = lyricLine.length;
            if (chordLine.length < pos) chordLine += ' '.repeat(pos - chordLine.length);
            chordLine = chordLine.slice(0, pos) + chord + chordLine.slice(pos + chord.length);
            i = end + 1;
            continue;
          }
        }
        lyricLine += ch;
        chordLine += (ch === '\t') ? '\t' : ' ';
        i++;
      }
      if (chordLine.length < lyricLine.length) chordLine += ' '.repeat(lyricLine.length - chordLine.length);
      return { chordLine, lyricLine };
    }

    function clearSongContent() { songContentEl.replaceChildren(); }
    function addCenteredTitle(text, level) {
      const el = document.createElement(level === 1 ? 'h1' : 'h2');
      el.style.textAlign = 'center';
      if (level === 2) el.style.color = '#888';
      el.textContent = text;
      songContentEl.appendChild(el);
    }
    function addChordBlock(chordLine, lyricLine) {
      const block = document.createElement('div');
      block.className = 'block';
      block.style.fontSize = fontSize + 'px';
      const preChord = document.createElement('pre');
      preChord.className = 'chordline';
      preChord.textContent = chordLine;
      const preLyric = document.createElement('pre');
      preLyric.className = 'lyricline';
      preLyric.textContent = lyricLine;
      if (chordLine.trim().length > 0) block.appendChild(preChord);
      block.appendChild(preLyric);
      songContentEl.appendChild(block);
    }
    function renderChordPro() {
      clearSongContent();
      const lines = currentRaw.split('\n');
      for (const line of lines) {
        const t = line.match(/\{t:(.*?)\}/);
        if (t) { addCenteredTitle(t[1], 1); continue; }
        const st = line.match(/\{st:(.*?)\}/);
        if (st) { addCenteredTitle(st[1], 2); continue; }
        const { chordLine, lyricLine } = parseChordProLine(line);
        addChordBlock(chordLine, lyricLine);
      }
    }

    // ------------------ sockets: load-song ------------------
    socket.on('load-song', (f) => {
      if (!isLeader) {
        const idx = allSongs.indexOf(f);
        if (idx !== -1) openSong(idx);
      }
    });

    // ------------------ Editor (global) ------------------
    async function openEditor() {
      const pin = await requirePinUI("PIN √©dition", "Entrez le PIN pour modifier la partition globale.");
      if (!pin) return;

      stopAutoScroll();
      document.getElementById('editor-textarea').value = currentRaw;
      document.getElementById('editor-container').style.display = 'block';
    }

    function closeEditor() { document.getElementById('editor-container').style.display = 'none'; }

    async function saveEditor() {
      const newContent = document.getElementById('editor-textarea').value;

      const pin = await requirePinUI("PIN √©dition", "PIN requis pour enregistrer.");
      if (!pin) return;

      const res = await fetch('/save-song', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fileName: currentFileName, content: newContent, pin })
      });

      if (res.ok) {
        currentRaw = newContent;
        renderChordPro();
        closeEditor();
        if (isLeader) socket.emit('change-song', { fileName: currentFileName, pin });
      } else if (res.status === 403) {
        alert("PIN invalide");
        clearStoredPin();
      } else {
        alert("Erreur d'enregistrement");
      }
    }

    function closeViewer() {
      stopAutoScroll();
      document.getElementById('library').style.display = 'block';
      document.getElementById('viewer-container').style.display = 'none';
    }

    // ------------------ utils ------------------
    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }

    // ------------------ init ------------------
    fetchSongs();

    // user init
    const cu = getCurrentUser();
    if (cu) {
      document.getElementById("currentUserLabel").textContent = cu;
      loadUserPrefs();
    } else {
      document.getElementById("currentUserLabel").textContent = "‚Äî";
      openUserModal();
      // prefs seront charg√©s d√®s s√©lection
    }
  </script>
</body>
</html>
