<script>
    const socket = io();
    let isLeader = false, allSongs = [], currentIndex = -1;
    let currentRaw = "", currentFileName = "", fontSize = 26, transposeValue = 0;
    let isScrolling = false, scrollInterval;
    
    // Sécurité pour éviter les boucles de scroll infinies
    let isRemoteScrolling = false; 

    socket.on('connect', () => {
        document.getElementById('navLeaderBtn').style.borderColor = "#4CAF50";
    });
    socket.on('disconnect', () => {
        document.getElementById('navLeaderBtn').style.borderColor = "#f44336";
    });

    async function fetchSongs() {
        const res = await fetch('/list-songs');
        allSongs = (await res.json()).sort();
        document.getElementById('songList').innerHTML = allSongs.map((s, idx) => `
            <div class="song-item" onclick="openSong(${idx})">
                <b>${s.replace('.pro','').replace('.cho','')}</b><span>❯</span>
            </div>`).join('');
    }

    function toggleLeader() {
        isLeader = !isLeader;
        const btns = [document.getElementById('libLeaderBtn'), document.getElementById('navLeaderBtn')];
        btns.forEach(btn => {
            btn.classList.toggle('leader-mode', isLeader);
            btn.innerText = isLeader ? "Mode Leader" : "Mode Solo";
        });
    }

    function openSong(idx) {
        if (idx < 0 || idx >= allSongs.length) return;
        currentIndex = idx;
        currentFileName = allSongs[idx];
        document.getElementById('library').style.display = 'none';
        document.getElementById('viewer-container').style.display = 'block';
        if(isLeader) socket.emit('change-song', currentFileName);
        loadSong(currentFileName);
    }

    async function loadSong(f) {
        const res = await fetch('/partitions/' + f);
        currentRaw = await res.text();
        transposeValue = 0;
        document.getElementById('transposeVal').innerText = "0";
        renderChordPro();
        document.getElementById('viewer').scrollTop = 0;
    }

    // --- GESTION DU SCROLL (LEADER ET ESCLAVE) ---
    const viewerElement = document.getElementById('viewer');

    // Le Leader envoie sa position
    viewerElement.addEventListener('scroll', () => {
        if (isLeader && !isRemoteScrolling) {
            const pos = viewerElement.scrollTop / (viewerElement.scrollHeight - viewerElement.clientHeight);
            socket.emit('scroll-sync', pos);
        }
    });

    // L'Esclave reçoit la position
    socket.on('apply-scroll', p => {
        if (!isLeader) {
            isRemoteScrolling = true; // On verrouille pour ne pas renvoyer l'event au serveur
            viewerElement.scrollTop = p * (viewerElement.scrollHeight - viewerElement.clientHeight);
            
            // On déverrouille après un court instant
            setTimeout(() => { isRemoteScrolling = false; }, 50);
        }
    });

    function toggleAutoScroll(emitSync) {
        isScrolling = !isScrolling;
        const btn = document.getElementById('playBtn');
        btn.innerText = isScrolling ? "⏸" : "▶";
        btn.classList.toggle('active-btn', isScrolling);
        
        if(isScrolling) {
            scrollInterval = setInterval(() => {
                viewerElement.scrollTop += 1;
            }, 105 - document.getElementById('scrollSpeed').value);
        } else { 
            clearInterval(scrollInterval); 
        }
        
        if(isLeader && emitSync) {
            socket.emit('sync-autoscroll', {active: isScrolling, speed: document.getElementById('scrollSpeed').value});
        }
    }

    function updateFontSize(delta) {
        fontSize += delta;
        renderChordPro();
        if(isLeader) socket.emit('sync-font', fontSize);
    }

    function updateTranspose(dir) {
        transposeValue += dir;
        document.getElementById('transposeVal').innerText = (transposeValue > 0 ? '+' : '') + transposeValue;
        renderChordPro();
        if(isLeader) socket.emit('sync-transpose', transposeValue);
    }

    // --- MOTEUR DE RENDU ---
    const scale = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const scaleLat = ['Do','Do#','Ré','Ré#','Mi','Fa','Fa#','Sol','Sol#','La','La#','Si'];
    
    function transChord(chord, steps) {
        return chord.replace(/([A-G][#b]?)/g, (match) => {
            let note = match.replace('Bb','A#').replace('Db','C#').replace('Eb','D#').replace('Gb','F#').replace('Ab','G#');
            let idx = scale.indexOf(note);
            if(idx === -1) return match;
            let newIdx = (idx + steps) % 12;
            if(newIdx < 0) newIdx += 12;
            return scaleLat[newIdx];
        });
    }

    function renderChordPro() {
        let html = "";
        currentRaw.split('\n').forEach(line => {
            if (line.includes('{t:')) html += `<h1 style="text-align:center">${line.match(/\{t:(.*?)\}/)[1]}</h1>`;
            else if (line.includes('{st:')) html += `<h2 style="text-align:center; color:#888;">${line.match(/\{st:(.*?)\}/)[1]}</h2>`;
            else {
                let proc = line.replace(/\[(.*?)\]/g, (m, c) => `<span class="chord">${transChord(c, transposeValue)}</span>`);
                html += `<div class="line" style="font-size:${fontSize}px">${proc}</div>`;
            }
        });
        document.getElementById('songContent').innerHTML = html;
    }

    // --- AUTRES SYNCHROS ---
    socket.on('load-song', f => { if(!isLeader) openSong(allSongs.indexOf(f)); });
    socket.on('apply-font', s => { if(!isLeader) { fontSize = s; renderChordPro(); } });
    socket.on('apply-transpose', v => { if(!isLeader) { transposeValue = v; renderChordPro(); } });
    socket.on('apply-autoscroll', d => { 
        if(!isLeader) { 
            document.getElementById('scrollSpeed').value = d.speed; 
            if(d.active !== isScrolling) toggleAutoScroll(false); 
        } 
    });

    // --- ÉDITEUR ET VUES ---
    function openEditor() {
        if(isScrolling) toggleAutoScroll(false);
        document.getElementById('editor-textarea').value = currentRaw;
        document.getElementById('editor-container').style.display = 'block';
    }
    function closeEditor() { document.getElementById('editor-container').style.display = 'none'; }
    async function saveEditor() {
        const newContent = document.getElementById('editor-textarea').value;
        const res = await fetch('/save-song', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ fileName: currentFileName, content: newContent })
        });
        if(res.ok) {
            currentRaw = newContent;
            renderChordPro();
            closeEditor();
            if(isLeader) socket.emit('change-song', currentFileName);
        }
    }
    function closeViewer() {
        if(isScrolling) toggleAutoScroll(false);
        document.getElementById('library').style.display = 'block';
        document.getElementById('viewer-container').style.display = 'none';
    }

    fetchSongs();
</script>